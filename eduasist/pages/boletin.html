<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EduAsist | Boleta</title>
</head>
<body>

  <h1>Boleta / Boletín (MVP)</h1>
  <p>Docente/Director puede consultar por DNI. Alumno/Apoderado también puede ver (por ahora por DNI).</p>

  <div id="estado">Cargando sesión...</div>
  <button id="btnLogout" type="button">Cerrar sesión</button>
  <p><a href="../dashboard.html">⬅ Volver al Dashboard EduAsist</a></p>

  <hr />

  <h2>1) Consultar por DNI del alumno</h2>
  <input id="dni" type="text" placeholder="DNI del alumno" />
  <button id="btnVer" type="button">Ver boleta</button>

  <br /><br />
  <label>Año:</label><br />
  <input id="anio" type="number" />
  <br /><br />

  <div id="infoAlumno"></div>

  <hr />

  <h2>2) Notas</h2>
  <div id="notasBox">-</div>

  <hr />

  <h2>3) Asistencia</h2>
  <div id="asisBox">-</div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../../assets/js/supabaseClient.js"></script>

  <script>
    let COLEGIO_ID = null;
    let USER_ID = null;
    let USER_ROLE = null;

    function setEstado(t){ document.getElementById('estado').textContent = t; }

    function hoyAnio(){ return new Date().getFullYear(); }

    async function requireSession() {
      const { data } = await window.supabase.auth.getSession();
      if (!data.session) {
        window.location.href = '../../login.html';
        return false;
      }

      USER_ID = data.session.user.id;

      const { data: profile, error } = await window.supabase
        .from('profiles')
        .select('role, is_active, colegio_id')
        .eq('id', USER_ID)
        .single();

      if (error || !profile || !profile.is_active) {
        await window.supabase.auth.signOut();
        window.location.href = '../../login.html';
        return false;
      }

      USER_ROLE = profile.role;
      COLEGIO_ID = profile.colegio_id;

      if (!COLEGIO_ID) {
        alert('⛔ No tienes colegio asignado.');
        window.location.href = '../dashboard.html';
        return false;
      }

      setEstado(`✅ Sesión activa (${USER_ROLE}) | colegio_id: ${COLEGIO_ID}`);
      return true;
    }

    async function buscarAlumnoPorDni(dni) {
      const { data: alumno, error } = await window.supabase
        .from('alumnos')
        .select('id, dni, nombres, apellidos, nivel, grado, seccion')
        .eq('colegio_id', COLEGIO_ID)
        .eq('dni', dni)
        .maybeSingle();

      if (error) throw new Error(error.message);
      return alumno;
    }

    async function cargarNotas(alumnoId) {
      const { data: notas, error } = await window.supabase
        .from('notas')
        .select('curso, periodo, nota_numerica, nota_literal, created_at')
        .eq('colegio_id', COLEGIO_ID)
        .eq('alumno_id', alumnoId)
        .order('curso', { ascending: true });

      if (error) throw new Error(error.message);
      return notas || [];
    }

    async function cargarAsistencia(alumnoId, anio) {
      // Traemos asistencia del año (simple): desde enero 1 hasta dic 31
      const start = `${anio}-01-01`;
      const end = `${anio}-12-31`;

      const { data: asis, error } = await window.supabase
        .from('asistencia')
        .select('fecha, estado')
        .eq('colegio_id', COLEGIO_ID)
        .eq('alumno_id', alumnoId)
        .gte('fecha', start)
        .lte('fecha', end)
        .order('fecha', { ascending: false });

      if (error) throw new Error(error.message);
      return asis || [];
    }

    function renderNotas(notas) {
      const box = document.getElementById('notasBox');
      if (!notas.length) {
        box.innerHTML = '<p>No hay notas registradas.</p>';
        return;
      }

      // agrupar por curso
      const map = {};
      for (const n of notas) {
        if (!map[n.curso]) map[n.curso] = [];
        map[n.curso].push(n);
      }

      let html = '';
      for (const curso of Object.keys(map)) {
        html += `<h3>${curso}</h3><ul>`;
        for (const n of map[curso]) {
          const val = (n.nota_numerica !== null && n.nota_numerica !== undefined)
            ? n.nota_numerica
            : (n.nota_literal || '-');
          html += `<li>${n.periodo}: <b>${val}</b></li>`;
        }
        html += `</ul>`;
      }
      box.innerHTML = html;
    }

    function renderAsistencia(asis) {
      const box = document.getElementById('asisBox');
      if (!asis.length) {
        box.innerHTML = '<p>No hay asistencia registrada.</p>';
        return;
      }

      const total = asis.length;
      const asistio = asis.filter(a => a.estado === 'asistio').length;
      const falto = asis.filter(a => a.estado === 'falto').length;
      const tard = asis.filter(a => a.estado === 'tardanza').length;

      let html = `<p><b>Total registros:</b> ${total}</p>`;
      html += `<p>✅ Asistió: ${asistio} | ❌ Faltó: ${falto} | ⏰ Tardanza: ${tard}</p>`;
      html += `<h3>Últimos registros</h3><ul>`;
      asis.slice(0, 20).forEach(a => {
        html += `<li>${a.fecha}: ${a.estado}</li>`;
      });
      html += `</ul>`;

      box.innerHTML = html;
    }

    async function verBoleta() {
      document.getElementById('infoAlumno').textContent = '';
      document.getElementById('notasBox').textContent = '-';
      document.getElementById('asisBox').textContent = '-';

      const dni = document.getElementById('dni').value.trim();
      const anio = parseInt(document.getElementById('anio').value, 10);

      if (!dni) return alert('⚠️ Ingresa DNI');
      if (!anio) return alert('⚠️ Año inválido');

      const alumno = await buscarAlumnoPorDni(dni);
      if (!alumno) {
        document.getElementById('infoAlumno').innerHTML = '<p>❌ Alumno no encontrado en este colegio.</p>';
        return;
      }

      document.getElementById('infoAlumno').innerHTML =
        `<p><b>${alumno.nombres} ${alumno.apellidos}</b> | DNI: ${alumno.dni}</p>
         <p>${alumno.nivel} ${alumno.grado}${alumno.seccion}</p>`;

      const notas = await cargarNotas(alumno.id);
      renderNotas(notas);

      const asis = await cargarAsistencia(alumno.id, anio);
      renderAsistencia(asis);
    }

    document.getElementById('btnVer').addEventListener('click', () => {
      verBoleta().catch(err => alert('❌ ' + err.message));
    });

    document.getElementById('btnLogout').addEventListener('click', async () => {
      await window.supabase.auth.signOut();
      window.location.href = '../../login.html';
    });

    (async () => {
      const ok = await requireSession();
      if (!ok) return;
      document.getElementById('anio').value = hoyAnio();
    })();
  </script>

</body>
</html>