<script>
  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const cleanDni = (x) => String(x || "").replace(/\D/g, "").slice(0, 8);

  function setStatus(msg, kind = "mini") {
    const el = $("status");
    el.className = kind;
    el.innerHTML = msg;
  }

  function setOut(obj) {
    $("out").textContent = JSON.stringify(obj, null, 2);
  }

  function getSb() {
    return window.supabaseClient || window.supabase;
  }

  // ✅ Obtiene token fresco (si está por expirar, refresca)
  async function getFreshToken() {
    const sb = getSb();
    if (!sb) return { token: null, error: new Error("Supabase no cargó") };

    const { data, error } = await sb.auth.getSession();
    if (error) return { token: null, error };

    let session = data?.session || null;
    if (!session?.access_token) return { token: null, session: null };

    // Si expira en <= 60s, refrescar
    const expiresAt = session.expires_at ? (session.expires_at * 1000) : 0;
    const msLeft = expiresAt - Date.now();

    if (expiresAt && msLeft <= 60000) {
      const { data: refreshed, error: rErr } = await sb.auth.refreshSession();
      if (rErr) return { token: null, error: rErr };
      session = refreshed?.session || session;
    }

    return { token: session.access_token, session };
  }

  async function ensureSession() {
    const sb = getSb();
    if (!sb) {
      $("sessionBox").innerHTML = '<span class="error">❌ Supabase no cargó</span>';
      return false;
    }

    const { token, session } = await getFreshToken();

    if (!token || !session?.user) {
      $("sessionBox").innerHTML =
        '<span class="error">❌ No hay sesión activa. Inicia sesión primero.</span> ' +
        '<a class="link" href="../../login.html">Ir al login</a>';
      return false;
    }

    $("sessionBox").innerHTML =
      '✅ Sesión activa: <b>' + (session.user.email || session.user.id) + '</b><br>' +
      '<span class="mini">user_id: ' + session.user.id + '</span>';

    return true;
  }

  async function callCreateUser(payload) {
    const { token } = await getFreshToken();
    if (!token) {
      return { ok: false, status: 401, data: { error: "No se pudo obtener token. Re-inicia sesión." } };
    }

    const res = await fetch("/.netlify/functions/create-user", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
      },
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  // =========================
  // MAIN
  // =========================
  document.addEventListener("DOMContentLoaded", async () => {
    await ensureSession();

    $("dni").addEventListener("input", () => {
      $("dni").value = cleanDni($("dni").value);
    });

    $("btnLogout").addEventListener("click", async () => {
      const sb = getSb();
      await sb?.auth?.signOut?.().catch(() => {});
      alert("Sesión cerrada. Vuelve a iniciar sesión.");
      location.href = "../../login.html";
    });

    $("btnCreate").addEventListener("click", async () => {
      $("btnCreate").disabled = true;

      try {
        const okSession = await ensureSession();
        if (!okSession) return;

        const dni = cleanDni($("dni").value);
        const role = String($("role").value || "").trim();
        const colegio_id = String($("colegio_id").value || "").trim();
        const must_change_password = $("must_change_password").checked;

        let initial_password = String($("initial_password").value || "").trim();
        if (!initial_password) initial_password = dni;

        if (!/^\d{8}$/.test(dni)) {
          setStatus('<span class="error">❌ DNI inválido (8 dígitos)</span>');
          return;
        }
        if (!colegio_id) {
          setStatus('<span class="error">❌ Falta colegio_id</span>');
          return;
        }
        if (!role) {
          setStatus('<span class="error">❌ Falta rol</span>');
          return;
        }

        setStatus("⏳ Creando usuario...");
        setOut({});

        const payload = { dni, role, colegio_id, initial_password, must_change_password };

        // 1er intento
        let r = await callCreateUser(payload);
        setOut(r.data);

        // ✅ Si es 401 por token, refresca sesión y reintenta 1 vez
        if (!r.ok && r.status === 401) {
          const sb = getSb();
          await sb?.auth?.refreshSession?.().catch(() => {});
          r = await callCreateUser(payload);
          setOut(r.data);
        }

        if (!r.ok) {
          setStatus('<span class="error">❌ ERROR: ' + (r.data?.error || "No se pudo crear") + '</span>');
          return;
        }

        setStatus('<span class="ok">✅ Usuario creado correctamente</span>');
        alert("✅ Creado: " + (r.data.email || "ok"));

      } catch (e) {
        setStatus('<span class="error">❌ Error: ' + (e?.message || e) + '</span>');
      } finally {
        $("btnCreate").disabled = false;
      }
    });
  });
</script>