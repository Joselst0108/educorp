<!DOCTYPE html>  <html lang="es">  
<head>  
  <meta charset="UTF-8" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />  
  <title>EduAdmin | Crear usuario</title>  
  <style>  
    body { font-family: system-ui, Arial; margin: 24px; max-width: 720px; }  
    .row { display: flex; gap: 12px; flex-wrap: wrap; }  
    .col { flex: 1; min-width: 220px; }  
    label { display:block; margin: 10px 0 6px; font-weight: 600; }  
    input, select, button {  
      width: 100%; padding: 10px; font-size: 16px;  
      border: 1px solid #cbd5e1; border-radius: 10px;  
    }  
    button { cursor:pointer; border:none; background:#0ea5e9; color:#fff; font-weight:700; }  
    button:disabled { opacity:.6; cursor:not-allowed; }  
    .muted { color:#64748b; font-size: 13px; margin-top: 6px; }  
    .card { border:1px solid #e2e8f0; border-radius: 14px; padding: 16px; margin-top: 14px; }  
    .error { color:#b91c1c; font-weight:700; }  
    .ok { color:#166534; font-weight:700; }  
    pre { background:#0b1220; color:#d1fae5; padding: 12px; border-radius: 12px; overflow:auto; }  
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; }  
    .link { color:#0ea5e9; text-decoration:none; font-weight:600; }  
    .mini { font-size: 12px; color:#475569; }  
  </style>  
</head>  
<body>    <div class="topbar">  
    <h2 style="margin:0">Crear usuario</h2>  
    <a class="link" href="../dashboard.html">← Volver al dashboard</a>  
  </div>    <div class="card">  
    <div id="sessionBox" class="mini">Verificando sesión...</div>  
  </div>    <div class="card">  
    <div class="row">  
      <div class="col">  
        <label>DNI</label>  
        <input id="dni" type="text" inputmode="numeric" placeholder="Ej: 45102999" maxlength="8" />  
        <div class="muted">Debe ser 8 dígitos.</div>  
      </div>  <div class="col">  
    <label>Rol</label>  
    <select id="role">  
      <option value="docente">docente</option>  
      <option value="alumno">alumno</option>  
      <option value="apoderado">apoderado</option>  
      <option value="director">director</option>  
      <option value="secretaria">secretaria</option>  
      <option value="superadmin">superadmin</option>  
    </select>  
  </div>  
</div>  

<label>Colegio ID (UUID)</label>  
<input id="colegio_id" type="text" placeholder="Ej: 8f818584-ef44-4e3a-9a33-02fc269971c8" />  

<label>Contraseña inicial</label>  
<input id="initial_password" type="text" placeholder="Recomendado: DNI (para forzar cambio 1ra vez)" />  
<div class="muted">  
  Si lo dejas vacío, se usará el DNI como contraseña inicial.  
</div>  

<div style="margin-top:10px">  
  <label style="display:flex;align-items:center;gap:10px;font-weight:600;">  
    <input id="must_change_password" type="checkbox" checked style="width:auto;transform:scale(1.2)" />  
    Forzar cambio de contraseña (solo 1ra vez)  
  </label>  
  <div class="muted">  
    Si está activado, el usuario verá el modal de cambio de contraseña solo en su primer ingreso.  
  </div>  
</div>  

<div class="row" style="margin-top:14px">  
  <div class="col">  
    <button id="btnCreate">Crear</button>  
    <div class="muted">Se enviará a Netlify Function: <b>/.netlify/functions/create-user</b></div>  
  </div>  
  <div class="col">  
    <button id="btnLogout" style="background:#334155">Cerrar sesión</button>  
    <div class="muted">Útil si el token expiró.</div>  
  </div>  
</div>

  </div>    <div class="card">  
    <div id="status"></div>  
    <pre id="out">{}</pre>  
  </div>    <!-- Scripts (orden IMPORTANTE) -->    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>    <!-- Ajusta esta ruta si tu supabaseClient.js está en otro lugar -->    <script src="../../assets/js/supabaseClient.js"></script>   
<script>
  // =========================
  // Helpers
  // =========================
  const $ = (id) => document.getElementById(id);
  const cleanDni = (x) => String(x || "").replace(/\D/g, "").slice(0, 8);

  function setStatus(msg, kind = "mini") {
    const el = $("status");
    el.className = kind;
    el.innerHTML = msg;
  }

  function setOut(obj) {
    $("out").textContent = JSON.stringify(obj, null, 2);
  }

  function getSb() {
    return window.supabaseClient || window.supabase;
  }

  // ✅ Obtiene token fresco (si está por expirar, refresca)
  async function getFreshToken() {
    const sb = getSb();
    if (!sb) return { token: null, error: new Error("Supabase no cargó") };

    const { data, error } = await sb.auth.getSession();
    if (error) return { token: null, error };

    let session = data?.session || null;
    if (!session?.access_token) return { token: null, session: null };

    // Si expira en <= 60s, refrescar
    const expiresAt = session.expires_at ? (session.expires_at * 1000) : 0;
    const msLeft = expiresAt - Date.now();

    if (expiresAt && msLeft <= 60000) {
      const { data: refreshed, error: rErr } = await sb.auth.refreshSession();
      if (rErr) return { token: null, error: rErr };
      session = refreshed?.session || session;
    }

    return { token: session.access_token, session };
  }

  async function ensureSession() {
    const sb = getSb();
    if (!sb) {
      $("sessionBox").innerHTML = '<span class="error">❌ Supabase no cargó</span>';
      return false;
    }

    const { token, session } = await getFreshToken();

    if (!token || !session?.user) {
      $("sessionBox").innerHTML =
        '<span class="error">❌ No hay sesión activa. Inicia sesión primero.</span> ' +
        '<a class="link" href="../../login.html">Ir al login</a>';
      return false;
    }

    $("sessionBox").innerHTML =
      '✅ Sesión activa: <b>' + (session.user.email || session.user.id) + '</b><br>' +
      '<span class="mini">user_id: ' + session.user.id + '</span>';

    return true;
  }

  async function callCreateUser(payload) {
    const { token } = await getFreshToken();
    if (!token) {
      return { ok: false, status: 401, data: { error: "No se pudo obtener token. Re-inicia sesión." } };
    }

    const res = await fetch("/.netlify/functions/create-user", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`,
      },
      body: JSON.stringify(payload),
    });

    const data = await res.json().catch(() => ({}));
    return { ok: res.ok, status: res.status, data };
  }

  // =========================
  // MAIN
  // =========================
  document.addEventListener("DOMContentLoaded", async () => {
    await ensureSession();

    $("dni").addEventListener("input", () => {
      $("dni").value = cleanDni($("dni").value);
    });

    $("btnLogout").addEventListener("click", async () => {
      const sb = getSb();
      await sb?.auth?.signOut?.().catch(() => {});
      alert("Sesión cerrada. Vuelve a iniciar sesión.");
      location.href = "../../login.html";
    });

    $("btnCreate").addEventListener("click", async () => {
      $("btnCreate").disabled = true;

      try {
        const okSession = await ensureSession();
        if (!okSession) return;

        const dni = cleanDni($("dni").value);
        const role = String($("role").value || "").trim();
        const colegio_id = String($("colegio_id").value || "").trim();
        const must_change_password = $("must_change_password").checked;

        let initial_password = String($("initial_password").value || "").trim();
        if (!initial_password) initial_password = dni;

        if (!/^\d{8}$/.test(dni)) {
          setStatus('<span class="error">❌ DNI inválido (8 dígitos)</span>');
          return;
        }
        if (!colegio_id) {
          setStatus('<span class="error">❌ Falta colegio_id</span>');
          return;
        }
        if (!role) {
          setStatus('<span class="error">❌ Falta rol</span>');
          return;
        }

        setStatus("⏳ Creando usuario...");
        setOut({});

        const payload = { dni, role, colegio_id, initial_password, must_change_password };

        // 1er intento
        let r = await callCreateUser(payload);
        setOut(r.data);

        // ✅ Si es 401 por token, refresca sesión y reintenta 1 vez
        if (!r.ok && r.status === 401) {
          const sb = getSb();
          await sb?.auth?.refreshSession?.().catch(() => {});
          r = await callCreateUser(payload);
          setOut(r.data);
        }

        if (!r.ok) {
          setStatus('<span class="error">❌ ERROR: ' + (r.data?.error || "No se pudo crear") + '</span>');
          return;
        }

        setStatus('<span class="ok">✅ Usuario creado correctamente</span>');
        alert("✅ Creado: " + (r.data.email || "ok"));

      } catch (e) {
        setStatus('<span class="error">❌ Error: ' + (e?.message || e) + '</span>');
      } finally {
        $("btnCreate").disabled = false;
      }
    });
  });
</script>
 </body>  
</html>