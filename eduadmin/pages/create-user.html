<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Crear usuario</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/assets/js/supabaseClient.js"></script>
</head>

<body>

<h2>Crear usuario</h2>

<input id="dni_apoderado" placeholder="DNI apoderado"><br><br>
<input id="dni_alumno" placeholder="DNI alumno"><br><br>
<input id="colegio_id" placeholder="UUID colegio"><br><br>

<button onclick="crear()">Crear usuario</button>

<p id="msg"></p>

<script>
async function verificarSesion() {
  const { data } = await window.supabase.auth.getSession();
  const session = data?.session;

  if (!session) {
    alert("Sesión expirada. Inicia sesión otra vez.");
    window.location.href = "/login.html";
    return null;
  }

  return session.access_token;
}

async function crear() {
  const msg = document.getElementById("msg");
  msg.textContent = "Creando...";

  const token = await verificarSesion();
  if (!token) return;

  const dni_apoderado = document.getElementById("dni_apoderado").value;
  const dni_alumno = document.getElementById("dni_alumno").value;
  const colegio_id = document.getElementById("colegio_id").value;

  try {
    const res = await fetch("/.netlify/functions/create-auth-and-links", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        colegio_id,
        dni_apoderado,
        dni_alumno
      })
    });

    const data = await res.json();

    if (!res.ok) {
      msg.style.color = "red";
      msg.textContent = data.error;
      return;
    }

    msg.style.color = "green";
    msg.textContent = "Usuario creado correctamente";

  } catch (e) {
    msg.textContent = "Error: " + e.message;
  }
}
</script>

</body>
</html>